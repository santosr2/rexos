# mise.toml - Tool and language management for RexOS
# Install mise: https://mise.jdx.dev/getting-started.html
# Run: mise install
#
# Inspired by: mise, uv, ripgrep, bat, fish-shell

min_version = "2024.1.1"

[env]
# Rust settings
CARGO_TERM_COLOR = "always"
RUST_BACKTRACE = "1"
CARGO_INCREMENTAL = "1"

# Cross-compilation settings
CROSS_CONTAINER_ENGINE = "docker"

# Add local binaries to PATH
_.path = ["./target/debug", "./target/release"]

[tools]
# Note: Using system Rust (install via rustup, not mise)
# Rust 1.85+ required for Edition 2024 and let chains

# Git & versioning
git-cliff = "latest"          # Changelog generator
gh = "latest"                 # GitHub CLI

# Shell script linting
shfmt = "latest"
shellcheck = "latest"

# YAML/JSON tools
yq = "latest"
jq = "latest"

# Pre-commit for git hooks
pre-commit = "latest"
actionlint = "latest"         # GitHub Actions linting

# C/C++ tooling (for emulator bridge)
cmake = "latest"
ninja = "latest"

# Python for Buildroot and scripts
python = "latest"

# Node.js for documentation/tooling
node = "lts"

# Cargo tools are installed via `mise run setup` using cargo install
# See [tasks.setup] below

[settings]
experimental = true

[tasks.setup]
description = "Initial project setup"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ”§ Setting up RexOS development environment..."

# Install Rust targets for cross-compilation
echo "ðŸ“¦ Installing Rust cross-compilation targets..."
rustup target add aarch64-unknown-linux-gnu
rustup target add armv7-unknown-linux-gnueabihf

# Install Rust components
echo "ðŸ“¦ Installing Rust components..."
rustup component add rustfmt clippy rust-analyzer

# Install cargo tools
echo "ðŸ“¦ Installing Cargo tools..."
cargo install cargo-watch cargo-audit cargo-outdated cargo-deny 2>/dev/null || true

# Setup pre-commit hooks
echo "ðŸª Setting up pre-commit hooks..."
pre-commit install

# Create necessary directories
echo "ðŸ“ Creating project directories..."
mkdir -p config/retroarch
mkdir -p docs/dev

echo "âœ… Setup complete!"
"""

[tasks.build]
description = "Build all workspace members"
run = "cargo build"

[tasks.build-release]
description = "Build release binaries"
run = "cargo build --release"

[tasks.test]
alias = "t"
description = "Run all tests with nextest"
run = "cargo nextest run --all-features"

[tasks."test:unit"]
description = "Run unit tests only"
run = "cargo nextest run --lib --all-features"

[tasks."test:integration"]
description = "Run integration tests"
run = "cargo nextest run --test '*' --all-features"

[tasks."test:verbose"]
description = "Run tests with output"
run = "cargo nextest run --all-features --no-capture"

[tasks."test:coverage"]
description = "Run tests with coverage"
run = """
cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
cargo llvm-cov report --html
echo "Coverage report: target/llvm-cov/html/index.html"
"""

[tasks.lint]
description = "Run all linters"
depends = ["lint:rust", "lint:toml", "lint:shell", "lint:yaml", "lint:markdown", "lint:spell"]

[tasks."lint:rust"]
description = "Lint Rust code"
run = """
#!/usr/bin/env bash
set -euo pipefail
echo "ðŸ” Checking Rust formatting..."
cargo fmt -- --check
echo "ðŸ” Running Clippy..."
cargo clippy --all-features --all-targets -- -D warnings
echo "âœ… Rust lints passed!"
"""

[tasks."lint:toml"]
description = "Lint TOML files"
run = "taplo check"

[tasks."lint:shell"]
description = "Lint shell scripts"
run = """
#!/usr/bin/env bash
set -euo pipefail
echo "ðŸ” Running shellcheck..."
find scripts -name "*.sh" -exec shellcheck {} + 2>/dev/null || true
echo "ðŸ” Checking shell formatting..."
shfmt -d scripts/ 2>/dev/null || true
echo "âœ… Shell lints passed!"
"""

[tasks."lint:yaml"]
description = "Lint YAML files"
run = """
#!/usr/bin/env bash
set -euo pipefail
echo "ðŸ” Linting YAML files..."
yamllint -c .yamllint.yaml . 2>/dev/null || yamllint .
echo "âœ… YAML lints passed!"
"""

[tasks."lint:markdown"]
description = "Lint Markdown files"
run = """
#!/usr/bin/env bash
set -euo pipefail
echo "ðŸ” Linting Markdown files..."
markdownlint '**/*.md' --ignore target --ignore vendor --ignore node_modules
echo "âœ… Markdown lints passed!"
"""

[tasks."lint:spell"]
description = "Check spelling in code and docs"
run = """
#!/usr/bin/env bash
set -euo pipefail
echo "ðŸ” Checking spelling..."
codespell --config .codespellrc .
echo "âœ… Spell check passed!"
"""

[tasks."lint:docker"]
description = "Lint Dockerfiles"
run = """
#!/usr/bin/env bash
set -euo pipefail
echo "ðŸ” Linting Dockerfiles..."
find . -name "Dockerfile*" -not -path "./target/*" -exec hadolint {} +
echo "âœ… Dockerfile lints passed!"
"""

[tasks.fmt]
description = "Format all code"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ“ Formatting Rust code..."
cargo fmt

echo "ðŸ“ Formatting shell scripts..."
if command -v shfmt &> /dev/null; then
    shfmt -w scripts/
fi

echo "âœ… Formatting complete!"
"""

[tasks.check]
description = "Quick compilation check"
run = "cargo check"

[tasks.clean]
description = "Clean build artifacts"
run = "cargo clean"

[tasks.watch]
description = "Watch for changes and rebuild"
run = "cargo watch -x check -x test"

[tasks.audit]
description = "Security audit dependencies"
run = "cargo audit"

[tasks.deny]
description = "Check licenses and security advisories"
run = "cargo deny check"

[tasks.security]
description = "Run all security checks"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ”’ Running security checks..."

echo ""
echo "Step 1/3: Cargo audit (vulnerability database)"
cargo audit

echo ""
echo "Step 2/3: Cargo deny (licenses & advisories)"
cargo deny check

echo ""
echo "Step 3/3: Detect secrets"
detect-secrets scan --baseline .secrets.baseline . 2>/dev/null || echo "âš ï¸ No secrets baseline found, run 'detect-secrets scan > .secrets.baseline' to create one"

echo ""
echo "âœ… Security checks passed!"
"""

[tasks.machete]
description = "Find unused dependencies"
run = "cargo machete"

[tasks.outdated]
description = "Check for outdated dependencies"
run = "cargo outdated"

[tasks.snapshots]
description = "Update test snapshots"
run = "cargo insta review"

[tasks."snapshots:accept"]
description = "Accept all pending snapshots"
run = "cargo insta accept"

[tasks.changelog]
description = "Generate changelog from commits"
run = "git-cliff -o CHANGELOG.md"

[tasks.release]
description = "Create a new release"
run = "cargo release"

[tasks.doc]
description = "Generate documentation"
run = "cargo doc --no-deps --open"

[tasks.cross-arm64]
description = "Cross-compile for aarch64 (RG353)"
run = "cross build --target aarch64-unknown-linux-gnu --release"

[tasks.cross-armv7]
description = "Cross-compile for armv7 (RG35XX)"
run = "cross build --target armv7-unknown-linux-gnueabihf --release"

[tasks.cross-all]
description = "Cross-compile for all targets"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ”¨ Building for aarch64 (RG353, RGB30, RG503)..."
cross build --target aarch64-unknown-linux-gnu --release

echo "ðŸ”¨ Building for armv7 (RG35XX)..."
cross build --target armv7-unknown-linux-gnueabihf --release

echo "âœ… Cross-compilation complete!"
echo ""
echo "Binaries available at:"
echo "  - target/aarch64-unknown-linux-gnu/release/"
echo "  - target/armv7-unknown-linux-gnueabihf/release/"
"""

[tasks.pre-commit]
description = "Run pre-commit on all files"
run = "pre-commit run --all-files"

[tasks.c-bridge]
description = "Build C emulator bridge"
run = """
#!/usr/bin/env bash
set -euo pipefail

if [ -d "c/emulator-bridge" ]; then
    echo "ðŸ”¨ Building C emulator bridge..."
    cd c/emulator-bridge
    make clean && make
    echo "âœ… C bridge built!"
else
    echo "âš ï¸ C emulator bridge directory not found"
fi
"""

[tasks.buildroot-config]
description = "Configure Buildroot for RG353"
run = """
#!/usr/bin/env bash
set -euo pipefail

BUILDROOT_DIR="${BUILDROOT_DIR:-../buildroot}"

if [ ! -d "$BUILDROOT_DIR" ]; then
    echo "ðŸ“¥ Cloning Buildroot..."
    git clone --depth 1 https://github.com/buildroot/buildroot.git "$BUILDROOT_DIR"
fi

echo "âš™ï¸ Configuring Buildroot with RexOS external tree..."
cd "$BUILDROOT_DIR"
make BR2_EXTERNAL="$(pwd)/../rexos/packaging/buildroot" rg353_defconfig

echo "âœ… Buildroot configured!"
echo "Run 'mise run buildroot-build' to build the full image"
"""

[tasks.buildroot-build]
description = "Build full OS image with Buildroot"
run = """
#!/usr/bin/env bash
set -euo pipefail

BUILDROOT_DIR="${BUILDROOT_DIR:-../buildroot}"

if [ ! -d "$BUILDROOT_DIR" ]; then
    echo "âŒ Buildroot not configured. Run 'mise run buildroot-config' first."
    exit 1
fi

echo "ðŸ”¨ Building RexOS image (this may take a while)..."
cd "$BUILDROOT_DIR"
make -j$(nproc)

echo "âœ… Build complete!"
echo "SD card image: $BUILDROOT_DIR/output/images/sdcard.img"
"""

[tasks.qemu-test]
description = "Run binaries in QEMU (requires qemu-user)"
run = """
#!/usr/bin/env bash
set -euo pipefail

BINARY="${1:-rexos-launcher}"
TARGET="aarch64-unknown-linux-gnu"

if [ ! -f "target/$TARGET/release/$BINARY" ]; then
    echo "Binary not found. Run 'mise run cross-arm64' first."
    exit 1
fi

echo "Running $BINARY in QEMU..."
qemu-aarch64 -L /usr/aarch64-linux-gnu "target/$TARGET/release/$BINARY"
"""

[tasks."test:mock"]
description = "Run tests with mock device profile"
run = """
#!/usr/bin/env bash
set -euo pipefail

PROFILE="${1:-rg353m}"
echo "Running tests with mock device: $PROFILE"
REXOS_MOCK_DEVICE="$PROFILE" cargo test --all-features
"""

[tasks."test:all-profiles"]
description = "Run tests against all mock device profiles"
run = """
#!/usr/bin/env bash
set -euo pipefail

profiles=("rg353m" "rg353v" "rg35xx" "rgb30" "rg503" "rg351p" "desktop")

for profile in "${profiles[@]}"; do
    echo ""
    echo "========================================"
    echo "Testing with profile: $profile"
    echo "========================================"
    REXOS_MOCK_DEVICE="$profile" cargo test --all-features || exit 1
done

echo ""
echo "All profile tests passed!"
"""

[tasks."test:qemu"]
description = "Run QEMU-based testing workflow"
run = "./testing/qemu/run-qemu.sh"

[tasks."test:qemu:shell"]
description = "Interactive ARM64 shell via Docker"
run = "./testing/qemu/run-qemu.sh shell"

[tasks."test:cross"]
description = "Run tests via cross-compilation"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "Running cross-compiled tests for ARM64..."
REXOS_MOCK_DEVICE=qemu_virt cross test --target aarch64-unknown-linux-gnu --all-features
"""

[tasks."test:native"]
description = "Run tests natively (Apple Silicon / aarch64 Linux)"
run = "./testing/qemu/run-qemu.sh native"

[tasks."launcher:setup"]
description = "Set up test ROM directory for launcher"
run = """
#!/usr/bin/env bash
ROMS_DIR="${REXOS_ROMS_DIR:-/tmp/rexos-test/roms}"
mkdir -p "$ROMS_DIR/.rexos" "$ROMS_DIR/snes" "$ROMS_DIR/nes" "$ROMS_DIR/gba" "$ROMS_DIR/genesis"
touch "$ROMS_DIR/snes/Super_Mario_World.sfc" "$ROMS_DIR/nes/Super_Mario_Bros.nes" "$ROMS_DIR/gba/Pokemon_Emerald.gba" 2>/dev/null || true
echo "Test ROM directory ready: $ROMS_DIR"
"""

[tasks."launcher:build"]
alias = "tui-build"
description = "Build the RexOS TUI launcher"
run = "cargo build -p rexos-launcher --release"

[tasks.flash-sd]
description = "Flash SD card image (requires sudo)"
run = """
#!/usr/bin/env bash
set -euo pipefail

BUILDROOT_DIR="${BUILDROOT_DIR:-../buildroot}"
IMAGE="$BUILDROOT_DIR/output/images/sdcard.img"

if [ ! -f "$IMAGE" ]; then
    echo "âŒ SD card image not found. Run 'mise run buildroot-build' first."
    exit 1
fi

echo "Available disks:"
if [[ "$OSTYPE" == "darwin"* ]]; then
    diskutil list
else
    lsblk
fi

echo ""
read -p "Enter target device (e.g., /dev/disk2 or /dev/sdb): " DEVICE

if [ -z "$DEVICE" ]; then
    echo "âŒ No device specified"
    exit 1
fi

echo "âš ï¸ WARNING: This will ERASE all data on $DEVICE"
read -p "Are you sure? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "Aborted."
    exit 1
fi

echo "ðŸ“ Flashing image to $DEVICE..."
if [[ "$OSTYPE" == "darwin"* ]]; then
    diskutil unmountDisk "$DEVICE"
    sudo dd if="$IMAGE" of="$DEVICE" bs=4m status=progress
    diskutil eject "$DEVICE"
else
    sudo dd if="$IMAGE" of="$DEVICE" bs=4M status=progress conv=fsync
    sync
fi

echo "âœ… Flash complete! You can now insert the SD card into your device."
"""

[tasks.ci]
description = "Run full CI pipeline locally"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ”„ Running CI pipeline..."

echo ""
echo "Step 1/5: Format check"
cargo fmt -- --check

echo ""
echo "Step 2/5: Clippy"
cargo clippy -- -D warnings

echo ""
echo "Step 3/5: Build"
cargo build --release

echo ""
echo "Step 4/5: Tests"
cargo test

echo ""
echo "Step 5/5: Security audit"
cargo audit || echo "âš ï¸ Audit warnings (non-blocking)"

echo ""
echo "âœ… CI pipeline passed!"
"""

[tasks.dev]
description = "Start development mode (watch + test)"
run = "cargo watch -x 'check' -x 'test' -x 'clippy'"

[tasks.info]
description = "Show project information"
run = """
#!/usr/bin/env bash

echo "RexOS Development Environment"
echo "=============================="
echo ""
echo "Rust version: $(rustc --version)"
echo "Cargo version: $(cargo --version)"
echo "Cross version: $(cross --version 2>/dev/null || echo 'not installed')"
echo ""
echo "Installed targets:"
rustup target list --installed
echo ""
echo "Workspace members:"
cargo metadata --format-version 1 --no-deps | jq -r '.packages[].name'
"""
